@page "/editor"
@rendermode InteractiveServer
@using DecisionTreeShared.Models
@using RulesEditor.Services
@inject DecisionTreeService TreeService

<PageTitle>Decision Tree Flow Builder</PageTitle>

<style>
    .flow-container {
        padding: 40px 20px;
        background: #f8f9fa;
        min-height: calc(100vh - 100px);
        overflow-x: auto;
    }
    
    .tree-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
    }
    
    .tree-row {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 30px;
        flex-wrap: wrap;
        position: relative;
    }
    
    .tree-node-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }
    
    .tree-node-box {
        background: white;
        border: 2px solid #0d6efd;
        border-radius: 10px;
        padding: 20px;
        min-width: 250px;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        position: relative;
    }
    
    .tree-node-box.start-node {
        border-color: #28a745;
        border-width: 3px;
    }
    
    .tree-node-box.end-node {
        border-color: #dc3545;
        background: #fff5f5;
    }
    
    .tree-node-box.answer-box {
        background: #e7f3ff;
        border-color: #0d6efd;
        min-width: 200px;
        font-weight: 500;
    }
    
    .node-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .node-actions {
        display: flex;
        gap: 5px;
    }
    
    .node-prompt {
        font-size: 15px;
        margin: 8px 0;
        color: #212529;
    }
    
    .connector-down {
        width: 2px;
        height: 30px;
        background: #6c757d;
        margin: 0 auto;
    }
    
    .connector-up {
        width: 2px;
        height: 30px;
        background: #6c757d;
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-1px);
    }
    
    .add-node-box {
        border: 2px dashed #6c757d;
        background: #f8f9fa;
        padding: 20px 30px;
        border-radius: 8px;
        text-align: center;
        min-width: 200px;
    }
    
    .flow-reference {
        background: #fff3cd;
        border: 2px dashed #856404;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-style: italic;
        min-width: 200px;
        font-size: 14px;
    }
    
    .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }
    
    .edit-modal-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-white border-bottom">
        <div>
            <h3 class="mb-0">Decision Tree Flow Builder</h3>
            <small class="text-muted">Follow the flow from top to bottom</small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success" @onclick="SaveTree">
                <i class="bi bi-save"></i> Save Tree
            </button>
            <label class="btn btn-info">
                <i class="bi bi-upload"></i> Load
                <InputFile OnChange="LoadFile" class="d-none" accept=".json" />
            </label>
            <button class="btn btn-secondary" @onclick="NewTree">
                <i class="bi bi-file-earmark-plus"></i> New
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mx-3" role="alert">
            @statusMessage
        </div>
    }

    <div class="flow-container">
        @if (string.IsNullOrEmpty(startNodeId) || !nodes.Any())
        {
            <div class="text-center py-5">
                <i class="bi bi-diagram-3" style="font-size: 4rem; color: #6c757d;"></i>
                <h4 class="mt-3">No Decision Tree Yet</h4>
                <p class="text-muted">Click "New Tree" or add your first node to get started</p>
                <button class="btn btn-primary btn-lg" @onclick="() => AddNodeAtPosition(null, null)">
                    <i class="bi bi-plus-circle"></i> Add First Node
                </button>
            </div>
        }
        else
        {
            <div class="tree-container">
                @RenderTreeByLevels()
            </div>
        }
    </div>
</div>

@if (editingNode != null)
{
    <div class="edit-modal" @onclick="CloseEditModal">
        <div class="edit-modal-content" @onclick:stopPropagation="true">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Edit Node</h5>
                <button class="btn-close" @onclick="CloseEditModal"></button>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Node ID</strong></label>
                <input type="text" class="form-control" @bind="editingNode.Id" />
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Node Type</strong></label>
                <select class="form-select" @bind="editingNode.Type">
                    <option value="End">End - Terminal node</option>
                    <option value="SingleChoice">Single Choice - Multiple options</option>
                    <option value="Number">Number - Numeric evaluation</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label"><strong>Prompt / Message</strong></label>
                <textarea class="form-control" rows="3" @bind="editingNode.Prompt"></textarea>
            </div>

            @if (editingNode.Type == "SingleChoice")
            {
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0"><strong>Choices</strong></label>
                        <button class="btn btn-sm btn-primary" @onclick="AddChoice">
                            <i class="bi bi-plus"></i> Add Choice
                        </button>
                    </div>
                    
                    @if (editingNode.Choices != null && editingNode.Choices.Any())
                    {
                        @for (int i = 0; i < editingNode.Choices.Count; i++)
                        {
                            var index = i;
                            var choice = editingNode.Choices[index];
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Choice @(index + 1)</small>
                                        <button class="btn btn-sm btn-danger" @onclick="() => RemoveChoice(index)">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    <input type="text" class="form-control form-control-sm mb-1" placeholder="Key" @bind="choice.Key" />
                                    <input type="text" class="form-control form-control-sm mb-1" placeholder="Label" @bind="choice.Label" />
                                    <select class="form-select form-select-sm" @bind="choice.NextNodeId">
                                        <option value="">-- Select Next Node --</option>
                                        @foreach (var node in nodes.Where(n => n.Id != editingNode.Id))
                                        {
                                            <option value="@node.Id">@node.Id</option>
                                        }
                                        <option value="_new_">+ Create New Node</option>
                                    </select>
                                </div>
                            </div>
                        }
                    }
                </div>
            }

            @if (editingNode.Type == "Number")
            {
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0"><strong>Rules</strong></label>
                        <button class="btn btn-sm btn-primary" @onclick="AddRule">
                            <i class="bi bi-plus"></i> Add Rule
                        </button>
                    </div>
                    
                    @if (editingNode.Rules != null && editingNode.Rules.Any())
                    {
                        @for (int i = 0; i < editingNode.Rules.Count; i++)
                        {
                            var index = i;
                            var rule = editingNode.Rules[index];
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Rule @(index + 1)</small>
                                        <button class="btn btn-sm btn-danger" @onclick="() => RemoveRule(index)">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    <select class="form-select form-select-sm mb-1" @bind="rule.Operator">
                                        <option value="LessThan">Less Than (&lt;)</option>
                                        <option value="LessThanOrEqual">Less Than or Equal (&lt;=)</option>
                                        <option value="GreaterThan">Greater Than (&gt;)</option>
                                        <option value="GreaterOrEqual">Greater Than or Equal (&gt;=)</option>
                                        <option value="Equal">Equal (=)</option>
                                    </select>
                                    <input type="number" class="form-control form-control-sm mb-1" placeholder="Value" @bind="rule.Value" />
                                    <select class="form-select form-select-sm" @bind="rule.NextNodeId">
                                        <option value="">-- Select Next Node --</option>
                                        @foreach (var node in nodes.Where(n => n.Id != editingNode.Id))
                                        {
                                            <option value="@node.Id">@node.Id</option>
                                        }
                                        <option value="_new_">+ Create New Node</option>
                                    </select>
                                </div>
                            </div>
                        }
                    }
                </div>
            }

            <div class="d-flex gap-2 justify-content-end">
                <button class="btn btn-secondary" @onclick="CloseEditModal">Close</button>
                <button class="btn btn-primary" @onclick="SaveEditedNode">Save Changes</button>
            </div>
        </div>
    </div>
}

@code {
    private string treeId = "my-decision-tree";
    private string treeVersion = "1.0.0";
    private string startNodeId = "";
    private List<DecisionNode> nodes = new();
    private DecisionNode? editingNode = null;
    private string statusMessage = "";
    private bool isSuccess = false;
    private HashSet<string> renderedNodes = new();

    protected override void OnInitialized()
    {
        LoadExampleTree();
    }

    private class TreeLevel
    {
        public List<TreeItem> Items { get; set; } = new();
    }
    
    private class TreeItem
    {
        public string? NodeId { get; set; }
        public string? BranchLabel { get; set; }
        public string? ParentNodeId { get; set; }
        public bool IsAnswerBox { get; set; }
    }
    
    private RenderFragment RenderTreeByLevels() => builder =>
    {
        var levels = BuildTreeLevels();
        
        foreach (var level in levels)
        {
            // Render connector from previous level (except for first level)
            if (levels.IndexOf(level) > 0)
            {
                builder.OpenElement(0, "div");
                builder.AddAttribute(1, "class", "connector-down");
                builder.CloseElement();
            }
            
            // Render the row
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "class", "tree-row");
            
            foreach (var item in level.Items)
            {
                if (item.IsAnswerBox)
                {
                    // This is an answer/choice box
                    builder.OpenElement(4, "div");
                    builder.AddAttribute(5, "class", "tree-node-wrapper");
                    
                    builder.OpenElement(6, "div");
                    builder.AddAttribute(7, "class", "tree-node-box answer-box");
                    builder.AddContent(8, item.BranchLabel);
                    builder.CloseElement();
                    
                    builder.CloseElement(); // wrapper
                }
                else if (!string.IsNullOrEmpty(item.NodeId))
                {
                    // This is a question node
                    builder.AddContent(9, RenderNodeBox(item.NodeId));
                }
            }
            
            builder.CloseElement(); // tree-row
        }
    };
    
    private List<TreeLevel> BuildTreeLevels()
    {
        var levels = new List<TreeLevel>();
        var processedNodes = new HashSet<string>();
        var queue = new Queue<(string nodeId, int level)>();
        
        if (!string.IsNullOrEmpty(startNodeId))
        {
            queue.Enqueue((startNodeId, 0));
        }
        
        while (queue.Count > 0)
        {
            var (nodeId, levelIndex) = queue.Dequeue();
            
            if (processedNodes.Contains(nodeId))
                continue;
                
            processedNodes.Add(nodeId);
            
            // Ensure we have enough levels
            while (levels.Count <= levelIndex)
            {
                levels.Add(new TreeLevel());
            }
            
            // Add this node to the current level
            levels[levelIndex].Items.Add(new TreeItem { NodeId = nodeId });
            
            // Get branches
            var node = nodes.FirstOrDefault(n => n.Id == nodeId);
            if (node != null && node.Type != "End")
            {
                var branches = GetNodeBranches(node);
                if (branches.Any())
                {
                    // Add answer boxes to next level
                    var answerLevel = levelIndex + 1;
                    while (levels.Count <= answerLevel)
                    {
                        levels.Add(new TreeLevel());
                    }
                    
                    foreach (var branch in branches)
                    {
                        // Add answer box
                        levels[answerLevel].Items.Add(new TreeItem 
                        { 
                            BranchLabel = branch.Label,
                            ParentNodeId = nodeId,
                            IsAnswerBox = true
                        });
                        
                        // Queue the next node if it exists
                        if (!string.IsNullOrEmpty(branch.NextNodeId))
                        {
                            queue.Enqueue((branch.NextNodeId, levelIndex + 2));
                        }
                    }
                }
            }
        }
        
        return levels;
    }
    
    private RenderFragment RenderNodeBox(string nodeId) => builder =>
    {
        var node = nodes.FirstOrDefault(n => n.Id == nodeId);
        if (node == null)
            return;
            
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "tree-node-wrapper");
        
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", $"tree-node-box {(node.Id == startNodeId ? "start-node" : "")} {(node.Type == "End" ? "end-node" : "")}");
        
        // Node header with badge and actions
        builder.OpenElement(4, "div");
        builder.AddAttribute(5, "class", "node-header");
        
        builder.OpenElement(6, "div");
        builder.OpenElement(7, "span");
        builder.AddAttribute(8, "class", $"badge bg-{GetNodeTypeBadge(node.Type)} me-2");
        builder.AddContent(9, node.Type);
        builder.CloseElement();
        builder.OpenElement(10, "strong");
        builder.AddAttribute(11, "style", "font-size: 12px;");
        builder.AddContent(12, node.Id);
        builder.CloseElement();
        if (node.Id == startNodeId)
        {
            builder.OpenElement(13, "span");
            builder.AddAttribute(14, "class", "badge bg-success ms-2");
            builder.AddContent(15, "START");
            builder.CloseElement();
        }
        builder.CloseElement();
        
        // Actions
        builder.OpenElement(16, "div");
        builder.AddAttribute(17, "class", "node-actions");
        builder.OpenElement(18, "button");
        builder.AddAttribute(19, "class", "btn btn-sm btn-primary");
        builder.AddAttribute(20, "onclick", EventCallback.Factory.Create(this, () => EditNode(node)));
        builder.OpenElement(21, "i");
        builder.AddAttribute(22, "class", "bi bi-pencil");
        builder.CloseElement();
        builder.CloseElement();
        builder.OpenElement(23, "button");
        builder.AddAttribute(24, "class", "btn btn-sm btn-danger");
        builder.AddAttribute(25, "onclick", EventCallback.Factory.Create(this, () => DeleteNode(node)));
        builder.OpenElement(26, "i");
        builder.AddAttribute(27, "class", "bi bi-trash");
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
        
        builder.CloseElement(); // node-header
        
        // Node prompt
        builder.OpenElement(28, "div");
        builder.AddAttribute(29, "class", "node-prompt");
        builder.AddContent(30, node.Prompt);
        builder.CloseElement();
        
        builder.CloseElement(); // tree-node-box
        builder.CloseElement(); // wrapper
    };

    private List<(string Label, string NextNodeId)> GetNodeBranches(DecisionNode node)
    {
        var branches = new List<(string Label, string NextNodeId)>();
        
        if (node.Type == "SingleChoice" && node.Choices != null)
        {
            foreach (var choice in node.Choices)
            {
                branches.Add((choice.Label, choice.NextNodeId ?? ""));
            }
        }
        else if (node.Type == "Number" && node.Rules != null)
        {
            foreach (var rule in node.Rules)
            {
                branches.Add(($"{rule.Operator} {rule.Value}", rule.NextNodeId ?? ""));
            }
        }
        
        return branches;
    }

    private void LoadExampleTree()
    {
        treeId = "essence-triage-demo";
        treeVersion = "1.0.0";
        startNodeId = "q_greeting";
        
        nodes = new List<DecisionNode>
        {
            new DecisionNode
            {
                Id = "q_greeting",
                Type = "SingleChoice",
                Prompt = "Welcome to Essence of Oregon support. What brings you here today?",
                Choices = new List<Choice>
                {
                    new Choice { Key = "cancel", Label = "I want to cancel my subscription", NextNodeId = "q_reason" },
                    new Choice { Key = "other", Label = "Something else", NextNodeId = "end_other" }
                }
            },
            new DecisionNode
            {
                Id = "q_reason",
                Type = "SingleChoice",
                Prompt = "What is the main reason for canceling?",
                Choices = new List<Choice>
                {
                    new Choice { Key = "affordability", Label = "It's too expensive", NextNodeId = "q_usage" },
                    new Choice { Key = "dont_like", Label = "I didn't like the product", NextNodeId = "end_cancelled" },
                    new Choice { Key = "other", Label = "Other reason", NextNodeId = "end_escalate" }
                }
            },
            new DecisionNode
            {
                Id = "q_usage",
                Type = "SingleChoice",
                Prompt = "Have you had a chance to use the product enough to see results?",
                Choices = new List<Choice>
                {
                    new Choice { Key = "yes", Label = "Yes", NextNodeId = "q_discount40" },
                    new Choice { Key = "no", Label = "Not really", NextNodeId = "q_extend_offer" }
                }
            },
            new DecisionNode
            {
                Id = "q_extend_offer",
                Type = "SingleChoice",
                Prompt = "We can extend your free trial by 15 days at no charge so you can evaluate further. Would you like to accept the extension?",
                Choices = new List<Choice>
                {
                    new Choice { Key = "accept", Label = "Yes, extend my free trial", NextNodeId = "end_extended" },
                    new Choice { Key = "decline", Label = "No, I'd still like to cancel", NextNodeId = "q_discount40" }
                }
            },
            new DecisionNode
            {
                Id = "q_discount40",
                Type = "SingleChoice",
                Prompt = "We can offer a lifetime 40% employee discount. Keep the subscription for $50.28/month (from $83.80)?",
                Choices = new List<Choice>
                {
                    new Choice { Key = "accept", Label = "Accept $50.28/month", NextNodeId = "end_keep40" },
                    new Choice { Key = "decline", Label = "Still can't afford it", NextNodeId = "q_affordable_price" }
                }
            },
            new DecisionNode
            {
                Id = "q_affordable_price",
                Type = "Number",
                Prompt = "What monthly price (USD) would make it affordable for you?",
                Rules = new List<Rule>
                {
                    new Rule { Operator = "LessThanOrEqual", Value = "20", NextNodeId = "end_supervisor_80" },
                    new Rule { Operator = "GreaterThan", Value = "20", NextNodeId = "end_cancelled" }
                }
            },
            new DecisionNode
            {
                Id = "end_extended",
                Type = "End",
                Prompt = "Your free trial has been extended by 15 days. Please evaluate and contact us before it ends if you still wish to cancel."
            },
            new DecisionNode
            {
                Id = "end_keep40",
                Type = "End",
                Prompt = "Great! Your subscription will continue at the 40% discounted rate of $50.28/month."
            },
            new DecisionNode
            {
                Id = "end_supervisor_80",
                Type = "End",
                Prompt = "Approved by supervisor: lifetime 80% discount. Your monthly price will be $16.76."
            },
            new DecisionNode
            {
                Id = "end_cancelled",
                Type = "End",
                Prompt = "Understood. Your subscription is canceled. Thank you for trying Essence of Oregon."
            },
            new DecisionNode
            {
                Id = "end_escalate",
                Type = "End",
                Prompt = "Thanks for the feedback. A specialist will review and follow up regarding your cancellation request."
            },
            new DecisionNode
            {
                Id = "end_other",
                Type = "End",
                Prompt = "Thanks for reaching out. Please contact support for assistance with non-cancellation inquiries."
            }
        };
        
        renderedNodes.Clear();
    }

    private void AddNodeAtPosition(string? parentNodeId, string? branchLabel)
    {
        var newNode = new DecisionNode
        {
            Id = $"node_{nodes.Count + 1}",
            Type = "End",
            Prompt = "Enter your prompt here"
        };
        nodes.Add(newNode);
        
        if (parentNodeId != null)
        {
            var parentNode = nodes.FirstOrDefault(n => n.Id == parentNodeId);
            if (parentNode != null)
            {
                if (parentNode.Type == "SingleChoice")
                {
                    var choice = parentNode.Choices?.FirstOrDefault(c => c.Label == branchLabel);
                    if (choice != null)
                    {
                        choice.NextNodeId = newNode.Id;
                    }
                }
                else if (parentNode.Type == "Number")
                {
                    var rule = parentNode.Rules?.FirstOrDefault(r => $"{r.Operator} {r.Value}" == branchLabel);
                    if (rule != null)
                    {
                        rule.NextNodeId = newNode.Id;
                    }
                }
            }
        }
        else if (string.IsNullOrEmpty(startNodeId))
        {
            startNodeId = newNode.Id;
        }
        
        editingNode = newNode;
        renderedNodes.Clear();
    }

    private void EditNode(DecisionNode node)
    {
        editingNode = node;
    }

    private void CloseEditModal()
    {
        editingNode = null;
        renderedNodes.Clear();
    }

    private void SaveEditedNode()
    {
        editingNode = null;
        renderedNodes.Clear();
    }

    private void DeleteNode(DecisionNode node)
    {
        nodes.Remove(node);
        if (startNodeId == node.Id)
        {
            startNodeId = nodes.Any() ? nodes.First().Id : "";
        }
        
        // Remove references to this node
        foreach (var n in nodes)
        {
            if (n.Choices != null)
            {
                foreach (var choice in n.Choices)
                {
                    if (choice.NextNodeId == node.Id)
                        choice.NextNodeId = "";
                }
            }
            if (n.Rules != null)
            {
                foreach (var rule in n.Rules)
                {
                    if (rule.NextNodeId == node.Id)
                        rule.NextNodeId = "";
                }
            }
        }
        
        renderedNodes.Clear();
    }

    private void AddChoice()
    {
        if (editingNode != null)
        {
            editingNode.Choices ??= new List<Choice>();
            editingNode.Choices.Add(new Choice 
            { 
                Key = $"choice{editingNode.Choices.Count + 1}",
                Label = "New Choice",
                NextNodeId = ""
            });
        }
    }

    private void RemoveChoice(int index)
    {
        if (editingNode?.Choices != null && index < editingNode.Choices.Count)
        {
            editingNode.Choices.RemoveAt(index);
        }
    }

    private void AddRule()
    {
        if (editingNode != null)
        {
            editingNode.Rules ??= new List<Rule>();
            editingNode.Rules.Add(new Rule 
            { 
                Operator = "LessThan",
                Value = "0",
                NextNodeId = ""
            });
        }
    }

    private void RemoveRule(int index)
    {
        if (editingNode?.Rules != null && index < editingNode.Rules.Count)
        {
            editingNode.Rules.RemoveAt(index);
        }
    }

    private void NewTree()
    {
        treeId = "new-tree";
        treeVersion = "1.0.0";
        startNodeId = "";
        nodes.Clear();
        editingNode = null;
        statusMessage = "";
        renderedNodes.Clear();
    }

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            
            var result = TreeService.LoadFromJson(json);
            if (result.Success && result.Tree != null)
            {
                treeId = result.Tree.Id;
                treeVersion = result.Tree.Version;
                startNodeId = result.Tree.StartNodeId;
                nodes = result.Tree.Nodes.Values.ToList();
                editingNode = null;
                statusMessage = "Tree loaded successfully!";
                isSuccess = true;
                renderedNodes.Clear();
            }
            else
            {
                statusMessage = $"Error loading tree: {result.ErrorMessage}";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error loading file: {ex.Message}";
            isSuccess = false;
        }
    }

    private void SaveTree()
    {
        try
        {
            var tree = new DecisionTree
            {
                Id = treeId,
                Version = treeVersion,
                StartNodeId = startNodeId,
                Nodes = nodes.ToDictionary(n => n.Id, n => n)
            };

            var json = TreeService.SerializeToJson(tree);
            var result = TreeService.LoadFromJson(json);
            
            if (result.Success)
            {
                var saveResult = TreeService.SaveToFile(tree, "rules.json");
                if (saveResult.Success)
                {
                    statusMessage = "✓ Tree saved successfully to rules.json!";
                    isSuccess = true;
                }
                else
                {
                    statusMessage = $"Error saving: {saveResult.ErrorMessage}";
                    isSuccess = false;
                }
            }
            else
            {
                statusMessage = $"Validation failed: {result.ErrorMessage}";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            isSuccess = false;
        }
    }

    private string GetNodeTypeBadge(string type) => type switch
    {
        "End" => "danger",
        "SingleChoice" => "primary",
        "Number" => "warning",
        _ => "secondary"
    };
}
